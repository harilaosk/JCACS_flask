{% extends "base.html" %}

{% block content %}
    <h1>Define Activities</h1>

    <!-- Form to Add New Activity -->
    <form method="POST" action="/add_activity" class="mb-3">
        <div class="row">
            <div class="col-md-4">
                <input type="text" name="activity_name" class="form-control" placeholder="Activity Name" required>
            </div>
            <div class="col-md-2">
                <input type="number" name="min_force" class="form-control" placeholder="Min Force" required>
            </div>
            <div class="col-md-2">
                <input type="number" name="max_force" class="form-control" placeholder="Max Force" required>
            </div>
            <div class="col-md-2">
                <input type="number" name="hold_time_min" class="form-control" placeholder="Hold Time Min" required>
            </div>
            <div class="col-md-2">
                <input type="number" name="hold_time_max" class="form-control" placeholder="Hold Time Max" required>
            </div>
            <div class="col-md-2 mt-2">
                <input type="number" name="start_angle" class="form-control" placeholder="Start Angle" required>
            </div>
            <div class="col-md-2 mt-2">
                <input type="number" name="end_angle" class="form-control" placeholder="End Angle" required>
            </div>
            <div class="col-md-2 mt-2">
                <button type="submit" class="btn btn-primary">Add Activity</button>
            </div>
        </div>
    </form>

    <!-- Table to Display and Edit Activities -->
    <h3>Defined Activities</h3>
<div class="table-responsive">
    <table class="table table-bordered table-striped table-hover">
        <thead class="thead-dark">
            <tr class="text-center">
                <th>Select</th>
                <th>Activity Name</th>
                <th>Min Force</th>
                <th>Max Force</th>
                <th>Hold Time Min</th>
                <th>Hold Time Max</th>
                <th>Start Angle</th>
                <th>End Angle</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for name, activity in activities.items() %}
            <tr>
                <td class="align-middle text-center">
                    <input type="checkbox" name="selected_activities" value="{{ name }}">
                </td>
                <td class="align-middle">{{ name }}</td>
                {% for key, value in activity.items() %}
                <td class="align-middle text-center" contenteditable="true"
                    onblur="updateActivity('{{ name }}', '{{ key }}', this.textContent)">
                    {{ value }}
                </td>
                {% endfor %}
                <td class="align-middle text-center">
                    <button class="btn btn-danger btn-sm" onclick="deleteActivity('{{ name }}')">Delete</button>
                    <button class="btn btn-success btn-sm" onclick="addToSequence('{{ name }}')">Add to Sequence</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    <div class="text-center">
        <button class="btn btn-secondary" onclick="exportSelected()">Export Selected</button>
        <button class="btn btn-danger" onclick="deleteSelectedActivities()">Delete Selected Activities</button>
    </div>






<form method="POST" action="/import_activities" enctype="multipart/form-data" class="mt-3">
    <input type="file" name="file" accept=".csv" required>
    <button type="submit" class="btn btn-secondary">Import Activities</button>
</form>
    <script>
        function updateActivity(activityName, key, value) {
            // Validate that the value is a number
            if (isNaN(value) || value.trim() === "") {
                alert("Please enter a valid number.");
                return;
            }

            // Send the update request
            fetch('/update_activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ activity_name: activityName, key: key, value: value }),
            })
            .then(response => {
                if (!response.ok) {
                    alert("Failed to update activity. Please try again!");
                }
            });
        }
    </script>
<script>
    // Function to delete activity
    function deleteActivity(activityName) {
        fetch(`/delete_activity/${activityName}`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                location.reload(); // Reload the page to reflect changes
            } else {
                alert('Failed to delete activity');
            }
        });
    }
    // Function to add activity to sequence
    function addToSequence(activityName) {
        fetch(`/add_activity_to_sequence/${activityName}`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                alert('Activity added to sequence successfully!');
            } else {
                alert('Failed to add activity to sequence.');
            }
        });
    }
    function exportSelected() {
        // Retrieve all selected checkboxes
        const selectedActivities = Array.from(document.querySelectorAll('input[name="selected_activities"]:checked'))
            .map(checkbox => checkbox.value);

        // Check if any activities are selected
        if (selectedActivities.length === 0) {
            alert('No activities selected for export.');
            return;
        }

        // Send the selected activities to the server
        fetch('/export_activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ selected_activities: selectedActivities })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Failed to export activities.');
            }
        })
        .then(blob => {
            // Create a downloadable link for the CSV file
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activities.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => {
            alert(error.message);
        });
    }
    // Function to delete selected activities
    function deleteSelectedActivities() {
        const selectedActivities = Array.from(document.querySelectorAll('input[name="selected_activities"]:checked'))
            .map(checkbox => checkbox.value);

        if (selectedActivities.length === 0) {
            alert("Please select at least one activity to delete.");
            return;
        }

        fetch('/delete_activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activities: selectedActivities }),
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Reload the page to reflect changes
            } else {
                alert("Failed to delete activities. Please try again!");
            }
        });
    }
</script>
{% endblock %}